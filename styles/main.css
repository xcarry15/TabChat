/* v0.3.4 | 2025-08-17
- 新增：左下角“历史”按钮与悬浮历史面板样式
- 历史列表区域默认可见至少20条（在视口允许范围内），其余滚动
- 修复：配合模式切换保留历史的交互，更新样式版本号
*/
:root {
  /* macOS/iOS 风格色板（深色） */
  --bg: #0b0b0c;
  --fg: #ffffff;
  --muted: #aeb3c2; /* 对应 secondaryLabel 近似 */
  --accent: #5b8cff; /* 柔和蓝，降低饱和度与对比度 */
  --error: #ff453a; /* iOS 系统红 */
  --surface: #1c1c1e; /* 系统分组背景 */
  --separator: #2c2c2e; /* 分隔线/描边 */
  --ring: color-mix(in oklab, var(--accent) 60%, transparent);
  --shadow: 0 0.5px 0.5px rgb(0 0 0 / 0.35), 0 6px 18px rgb(0 0 0 / 0.25);
  /* 页面底部的安全留白（用于 AI 输出容器与页面底部的最大距离） */
  --bottom-gap: clamp(16px, 10vh, 88px);
}

/* 已移除浅色主题，仅保留深色主题变量 */

html, body {
  height: 100%;
  overflow: hidden; /* 禁止页面滚动 */
  overscroll-behavior: none;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Noto Sans SC, Helvetica, Arial, "Microsoft Yahei", "PingFang SC", sans-serif;
}

/* 全屏背景画布 */
#bg {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1;
  pointer-events: none; /* 不拦截交互 */
}

@supports (height: 100dvh) {
  #bg {
    height: 100dvh;
  }
}

#app {
  display: grid;
  grid-template-rows: auto 1fr;
  min-height: 100vh;
  height: 100vh; /* 填充视口高度 */
}

@supports (height: 100dvh) {
  #app {
    min-height: 100dvh;
    height: 100dvh;
  }
}

/* 顶部时间区域弱化，搜索居中 */
#clock {
  display: grid;
  place-items: center;
  text-align: center;
  padding-top: 3vh;
}

#clock-time {
  font-size: clamp(56px, 16vw, 160px);
  letter-spacing: 0.02em;
  font-weight: 600;
  text-shadow: 0 1px 2px rgb(0 0 0 / 0.35);
}

#clock-date {
  margin-top: 8px;
  font-size: clamp(14px, 2.2vw, 18px);
  color: var(--muted);
  /* 移动到屏幕左上角 */
  position: fixed;
  top: 14px;
  left: 16px;
  margin-top: 0;
  z-index: 10;
}

#chat {
  width: min(820px, 92vw);
  margin: 0 auto;
  display: grid;
  align-content: start;
  /* 搜索栏、输出、错误信息三行：输出按内容增长，达到上限后在容器内滚动 */
  grid-template-rows: auto auto auto auto;
  /* 允许在父级网格中收缩，避免内容导致超出视口 */
  min-height: 0;
  padding-top: 2vh; /* 再往上移一些 */
  /* 为子元素在底部提供非折叠的留白，避免触底 */
  padding-bottom: var(--bottom-gap);
}

/* 移除空支持块（无效残留） */

.chat-bar {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  background: color-mix(in oklab, var(--surface) 60%, transparent);
  -webkit-backdrop-filter: saturate(180%) blur(18px);
  backdrop-filter: saturate(180%) blur(18px);
  /* 显式半透明背景，确保各浏览器下依然可见模糊与通透感 */
  background-color: rgba(28, 28, 30, 0.18);
  border: 1px solid var(--separator);
  border-radius: 20px;
  padding: 14px 14px 14px 16px;
  box-shadow: var(--shadow);
}

/* 输入聚焦时，使用容器提供更优雅的聚焦指示 */
.chat-bar:focus-within {
  background: color-mix(in oklab, var(--surface) 66%, transparent);
  background-color: rgba(28, 28, 30, 0.22);
  border-color: color-mix(in oklab, var(--accent) 28%, var(--separator));
  box-shadow: var(--shadow), 0 0 0 2px color-mix(in oklab, var(--accent) 18%, transparent);
}

/* 输入区域外包裹，确保按钮位于右侧但不抢占输入边距 */
.input-wrap {
  display: flex;
  align-items: center;
}

textarea#input {
  width: 100%;
  resize: none;
  border: none;
  outline: none;
  background: transparent;
  color: var(--fg);
  font-size: 16px;
  line-height: 1.5;
  max-height: 15vh;
  caret-color: var(--accent);
}

/* 移除输入框自身焦点时的亮色边框（由容器提供视觉反馈） */
textarea#input:focus,
textarea#input:focus-visible {
  outline: none;
  box-shadow: none;
}

textarea#input::placeholder {
  color: var(--muted);
}

.actions {
  display: flex;
  gap: 6px;
}

/* 统一按钮系统 */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 64px;
  height: 36px;
  padding: 0 14px;
  border-radius: 9999px;
  font-size: 14px;
  font-weight: 600;
  border: 1px solid var(--separator);
  cursor: pointer;
  user-select: none;
  background: color-mix(in oklab, var(--surface) 80%, transparent);
  color: var(--fg);
  transition: transform 120ms ease, box-shadow 160ms ease, filter 120ms ease, background 160ms ease, border-color 160ms ease, color 160ms ease;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: color-mix(in oklab, var(--accent) 18%, var(--surface));
  color: #fff;
  border-color: color-mix(in oklab, var(--accent) 28%, var(--separator));
  box-shadow: 0 1px 2px rgb(0 0 0 / 0.22);
}

.btn-neutral {
  background: transparent;
  color: var(--fg);
  border-color: var(--separator);
  box-shadow: none;
}

.btn-ghost {
  background: transparent;
  color: var(--muted);
  border-color: color-mix(in oklab, var(--separator) 60%, transparent);
}

.btn:not(:disabled):hover { filter: brightness(1.06); }

.btn:not(:disabled):active { transform: translateY(1px) scale(0.995); box-shadow: 0 0 0 rgb(0 0 0 / 0); }

/* 强化主要按钮的悬停高光与按压反馈 */
.btn-primary:not(:disabled):hover { box-shadow: 0 2px 8px rgb(0 0 0 / 0.24); }

.btn-primary:not(:disabled):active { background: color-mix(in oklab, var(--accent) 22%, var(--surface)); }

/* 半透明按钮风格：用于与整体磨砂风格统一 */
.btn-translucent {
  background: color-mix(in oklab, var(--surface) 60%, transparent);
  color: var(--fg);
  border-color: color-mix(in oklab, var(--separator) 80%, transparent);
  box-shadow: 0 1px 2px rgb(0 0 0 / 0.22);
}
.btn-translucent:not(:disabled):hover { filter: brightness(1.06); box-shadow: 0 2px 8px rgb(0 0 0 / 0.24); }
.btn-translucent:not(:disabled):active { transform: translateY(1px) scale(0.995); box-shadow: 0 0 0 rgb(0 0 0 / 0); }

.output {
  margin-top: 12px;
  padding: 14px 16px;
  background: color-mix(in oklab, var(--surface) 60%, transparent);
  -webkit-backdrop-filter: saturate(180%) blur(18px);
  backdrop-filter: saturate(180%) blur(18px);
  /* 显式半透明背景，确保各浏览器下依然可见模糊与通透感 */
  background-color: rgba(28, 28, 30, 0.18);
  border-radius: 16px;
  border: 1px solid var(--separator);
  /* 允许在 Grid 中收缩以适配容器高度 */
  min-height: 0;
  box-shadow: var(--shadow);
  /* 内容短时不出现滚动条；内容过长时在容器内部滚动 */
  overflow: auto;
}

/* 顶部工具条：将搜索/AI/停止/重置移至输入框外，贴近右侧 */
.chat-actions-toolbar {
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  margin-top: 10px;
}
.chat-actions-toolbar .toolbar-right {
  display: flex;
  gap: 8px;
}
.chat-actions-toolbar .toolbar-controls[hidden] { display: none !important; }

/* 表格与引用的样式优化 */
.output blockquote {
  margin: 0.6em 0;
  padding: 8px 12px;
  border-left: 3px solid color-mix(in oklab, var(--accent) 40%, var(--separator));
  background: color-mix(in oklab, var(--surface) 90%, transparent);
  border-radius: 8px;
}

.output .table-container { width: 100%; overflow-x: auto; }
.output table { width: 100%; border-collapse: collapse; border-spacing: 0; }
.output thead th { position: sticky; top: 0; background: color-mix(in oklab, var(--surface) 96%, transparent); }
.output th, .output td { border: 1px solid var(--separator); padding: 8px 10px; text-align: left; vertical-align: top; }
.output tr:nth-child(even) td { background: color-mix(in oklab, var(--surface) 92%, transparent); }

@supports (height: 100dvh) {
  :root { --bottom-gap: clamp(16px, 5dvh, 48px); }
}

/* AI 进行中：仅对设置弹窗关闭模糊，保持输入与输出区域的半透明/模糊效果不变 */
.ai-busy dialog#settingsDialog {
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
}

.output-controls {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-bottom: 10px;
}

.output-content { min-height: 20px; }

/* 流式渐显动画：每个增量块轻微淡入 */
.stream-chunk {
  opacity: 0;
  animation: streamFadeIn 240ms ease-out forwards;
}
@keyframes streamFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Markdown 样式增强 */
.output p { margin: 0.4em 0; }
.output h1, .output h2, .output h3, .output h4, .output h5, .output h6 {
  margin: 0.8em 0 0.4em;
  line-height: 1.25;
}
.output h1 { font-size: 1.6em; }
.output h2 { font-size: 1.4em; }
.output h3 { font-size: 1.2em; }
.output ul, .output ol { margin: 0.5em 0 0.5em 1.5em; }
.output li { margin: 0.25em 0; }
.output code {
  background: color-mix(in oklab, var(--surface) 86%, transparent);
  border: 1px solid var(--separator);
  padding: 0 0.35em;
  border-radius: 6px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.95em;
}
.output pre {
  margin: 0.6em 0;
  padding: 10px 12px;
  background: color-mix(in oklab, var(--surface) 92%, transparent);
  border: 1px solid var(--separator);
  border-radius: 10px;
  overflow: auto;
}
.output pre code {
  border: 0;
  padding: 0;
  background: transparent;
}
.output a { color: var(--accent); text-decoration: underline; }
/* 右上角悬浮主题按钮 */
.theme-floating {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 10;
}

/* 右上角悬浮设置按钮 */
.settings-floating { position: fixed; top: 14px; right: 14px; z-index: 10; }

/* 左下角悬浮历史按钮 */
.history-floating {
  position: fixed;
  left: 14px;
  bottom: 14px;
  z-index: 11;
}

/* 历史面板 */
.history-panel {
  position: fixed;
  left: 14px;
  bottom: 64px;
  width: min(420px, 92vw);
  background: color-mix(in oklab, var(--surface) 96%, transparent);
  -webkit-backdrop-filter: saturate(180%) blur(18px);
  backdrop-filter: saturate(180%) blur(18px);
  border: 1px solid var(--separator);
  border-radius: 16px;
  box-shadow: var(--shadow);
  color: var(--fg);
  display: grid;
  grid-template-rows: auto 1fr auto;
  z-index: 12;
}
.history-panel[hidden] { display: none !important; }

.history-header, .history-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  border-bottom: 1px solid var(--separator);
}
.history-footer { border-top: 1px solid var(--separator); border-bottom: 0; justify-content: flex-end; }
.history-title { margin: 0; font-size: 14px; font-weight: 700; }
.muted { color: var(--muted); }

/* 历史列表：保证至少20条可见（估算每项行高约 42px） */
.history-list {
  padding: 8px;
  overflow: auto;
  /* 20 条 * 42px ≈ 840px，使用 clamp 受视口限制 */
  max-height: clamp(320px, 80vh, 840px);
  min-height: 160px;
}

.history-item {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px;
  padding: 8px 10px;
  border: 1px solid var(--separator);
  border-radius: 10px;
  background: color-mix(in oklab, var(--surface) 92%, transparent);
  cursor: pointer;
}
.history-item + .history-item { margin-top: 8px; }
.history-item:hover { filter: brightness(1.06); }
.history-item:active { transform: translateY(1px); }
.history-item-index { font-size: 12px; color: var(--muted); padding-top: 2px; }
.history-item-user { font-weight: 600; font-size: 14px; }
.history-item-assistant { margin-top: 4px; font-size: 13px; color: var(--muted); }
.history-empty { color: var(--muted); text-align: center; padding: 24px 0; }

.error {
  margin-top: 10px;
  color: var(--error);
}

dialog#settingsDialog::backdrop {
  background: rgb(0 0 0 / 0.45);
}

dialog#settingsDialog {
  border: 0;
  border-radius: 20px;
  padding: 12px 14px;
  background: color-mix(in oklab, var(--surface) 96%, transparent);
  -webkit-backdrop-filter: saturate(180%) blur(18px);
  backdrop-filter: saturate(180%) blur(18px);
  color: var(--fg);
  width: min(720px, 94vw);
  box-shadow: var(--shadow);
}

dialog#settingsDialog form { display: grid; gap: 10px; }

/* 双列自适应网格：小屏单列，大屏 2 列 */
dialog#settingsDialog form > h2 { margin: 0 0 4px; font-size: 16px; font-weight: 700; }
dialog#settingsDialog form > label,
dialog#settingsDialog form > fieldset {
  display: grid;
  gap: 6px;
  padding: 10px;
  border: 1px solid var(--separator);
  border-radius: 12px;
  background: color-mix(in oklab, var(--surface) 92%, transparent);
  /* 允许网格子项在两列布局时收缩，避免内容溢出重叠 */
  min-width: 0;
}

dialog#settingsDialog form > .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* 输入控件更紧凑 */
/* 合并输入/文本域的通用样式，分别定义差异 */
dialog#settingsDialog input,
dialog#settingsDialog textarea {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  border: 1px solid var(--separator);
  background: transparent;
  color: var(--fg);
  transition: box-shadow 120ms ease, border-color 120ms ease;
}
dialog#settingsDialog textarea {
  min-height: 64px;
  resize: vertical;
  padding: 8px 10px;
  border-radius: 10px;
}

dialog#settingsDialog input {
  padding: 10px 12px;
  border-radius: 12px;
}

dialog#settingsDialog menu {
  display: flex;
  gap: 6px;
  justify-content: flex-end;
}

/* Fieldset 标题紧凑 */
dialog#settingsDialog fieldset { margin: 0; }
dialog#settingsDialog fieldset > legend { font-size: 12px; color: var(--muted); padding: 0 4px; }

/* 布局细化：将基础设置放两列，增强信息密度 */
dialog#settingsDialog form > label { margin: 0; }
@media (min-width: 680px) {
  dialog#settingsDialog form {
    /* 自适应列数，避免临界宽度下两列拥挤导致重叠 */
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }
  dialog#settingsDialog form > h2 { grid-column: 1 / -1; }
  dialog#settingsDialog form > label { grid-column: auto; }
  dialog#settingsDialog form > fieldset { grid-column: 1 / -1; }
  dialog#settingsDialog menu { grid-column: 1 / -1; }
}

/* 可访问性：聚焦可见（输入框改由容器高亮，不直接加亮边） */
dialog#settingsDialog input:focus-visible,
.actions button:focus-visible,
.chat-actions-toolbar button:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px var(--ring);
  border-color: color-mix(in oklab, var(--accent) 50%, var(--separator));
}

/* 减少动效偏好支持 */
@media (prefers-reduced-motion: reduce) {
  .actions button {
    transition: none;
  }
}

/* 统一滚动条外观：更轻、更圆润，贴合整体半透明风格 */
* {
  scrollbar-width: thin;
  scrollbar-color: color-mix(in oklab, var(--accent) 35%, var(--surface)) transparent;
}

/* Chromium/WebKit 滚动条定制 */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: color-mix(in oklab, var(--accent) 28%, var(--surface));
  border-radius: 9999px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover {
  background: color-mix(in oklab, var(--accent) 36%, var(--surface));
}
::-webkit-scrollbar-thumb:active {
  background: color-mix(in oklab, var(--accent) 44%, var(--surface));
}

